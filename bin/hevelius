#!/usr/bin/env python3

"""
Provides command line interface to the Hevelius project.
"""

import sys
import argparse

sys.path.append(".")

from hevelius.cmd_basic import db_version, hevelius_version, config_show, backup
from hevelius.cmd_stats import stats, histogram_show, groups
from hevelius.cmd_db_migrate import migrate
from hevelius.cmd_repo import repo
from hevelius.cmd_catalog import catalog, format_get

if __name__ == '__main__':
    print(f"Hevelius {hevelius_version()}")
    print()

    parser = argparse.ArgumentParser("hevelius")
    subparsers = parser.add_subparsers(help="commands", dest="command")

    stats_parser = subparsers.add_parser('stats', help="Show database statistics")
    migrate_parser = subparsers.add_parser('migrate', help="Migrate to the latest DB schema")
    migrate_parser.add_argument("-t", "--dry-run", help="Don't do the actual DB upsert", action='store_true')

    version_parser = subparsers.add_parser('version', help="Shows the current DB schema version.")
    config_parser = subparsers.add_parser('config', help="Shows current DB configuration.")
    backup_parser = subparsers.add_parser('backup', help="Generates DB backup.")

    repo_parser = subparsers.add_parser('repo', help="Manages files repository on local storage.")
    repo_parser.add_argument('-f', "--file", help="Reads a single FITS file", type=str)
    repo_parser.add_argument("-l", "--list", help="Reads a list of FITS files (one filename per line)", type=str)
    repo_parser.add_argument("-d", "--dir",   help="Reads all FITS files recursively", type=str)
    repo_parser.add_argument("-s", "--show-header", help="Displays all entries in FITS header", action='store_true')
    repo_parser.add_argument("-t", "--dry-run", help="Don't do the actual DB upsert", action='store_true')
    repo_parser.add_argument("--sanity-db", help="Goes through the list of tasks in a database and checks if all files are present", action='store_true')
    repo_parser.add_argument("--sanity-files", help="Goes through the list of files and check if related tasks are present", action='store_true')

    distrib_parser = subparsers.add_parser('distrib', help="Shows photos distribution")
    groups_parser = subparsers.add_parser('groups', help="Shows frames' groups")
    groups_parser.add_argument("-m", "--min", help="Minimum number of frames in a group", type=int, default=200)

    # Default values set to the first Messier object
    catalog_parser = subparsers.add_parser('catalog', help="Finds astronomical objects in a catalog")
    catalog_parser.add_argument('-r', "--ra", help="Right Ascension (HH MM [SS] format)", type=str, default="05 34 31")
    catalog_parser.add_argument('-d', "--decl", help="Declination of the image searched (+DD MM SS format)", type=str, default="+22 00 52")
    catalog_parser.add_argument('-p', "--proximity", help="radius of an area to look at (in degrees)", type=float, default=1.0)
    catalog_parser.add_argument('-f', "--format", help="format of the frames list output: none, filenames, csv, brief, full", type=format_get, default="brief")
    catalog_parser.add_argument('-o', "--object", help="catalog object to look for", type=str, default="")
    catalog_parser.add_argument('-b', "--bin", help="filtering: binning of the frames to look for (1..4, 0 means any)", type=int, default=0)
    catalog_parser.add_argument("--focal", help="filtering: focal length (mm)", type=int, default=0)
    catalog_parser.add_argument("--resx", help="filtering: X resolution (pixels)", type=int, default=0)
    catalog_parser.add_argument("--resy", help="filtering: y resolution (pixels)", type=int, default=0)

    args = parser.parse_args()

    if args.command == "stats":
        stats()  # see cmd_stats.py
    elif args.command == "migrate":
        migrate(args)  # see cmd_db_migrate.py
    elif args.command == "version":
        db_version()  # see cmd_basic.py
    elif args.command == "config":
        config_show()  # see cmd_basic.py
    elif args.command == "repo":
        repo(args)  # see cmd_repo.py
    elif args.command == "distrib":
        histogram_show(args)  # see cmd_stats.py
    elif args.command == "groups":
        groups(args)  # see cmd_stats.py
    elif args.command == "backup":
        backup(args)  # see cmd_backup.py
    elif args.command == "catalog":
        catalog(args)  # see cmd_catalog.py

    else:
        parser.print_help()
